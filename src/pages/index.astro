---
import Layout from "@layouts/Layout.astro";
import Container from "@components/Container.astro";
import { SITE, HOME, SOCIALS } from "@consts";
import ArrowCard from "@components/ArrowCard.astro";
import Link from "@components/Link.astro";
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";

// Add logging to see what's happening with content
console.log(`[Build Info] Environment: ${import.meta.env.MODE}`);

// Get all issues first
const allIssuesRaw = await getCollection("issues");
console.log(`[Content Log] Total raw issues before filtering: ${allIssuesRaw.length}`);

// Log the years represented in the content
const years = new Set(allIssuesRaw.map(post => new Date(post.data.date).getFullYear()));
console.log(`[Content Log] Years found in content: ${[...years].sort().join(', ')}`);

// Count 2025 issues specifically
const issues2025 = allIssuesRaw.filter(post => new Date(post.data.date).getFullYear() === 2025);
console.log(`[Content Log] Number of 2025 issues found: ${issues2025.length}`);
if (issues2025.length > 0) {
  console.log(`[Content Log] 2025 issues:`, issues2025.map(i => ({ id: i.id, date: i.data.date, draft: i.data.draft })));
}

// Apply filtering
const allIssues = allIssuesRaw
  .filter((post) => {
    const isDraft = !!post.data.draft;
    if (isDraft) {
      console.log(`[Content Log] Filtered out draft post: ${post.id}`);
    }
    return !isDraft;
  })
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

console.log(`[Content Log] Total issues after filtering: ${allIssues.length}`);

// Initial batch of 30 issues
const ITEMS_PER_PAGE = 30;
const totalPages = Math.ceil(allIssues.length / ITEMS_PER_PAGE);

const projects: CollectionEntry<"projects">[] = (
  await getCollection("projects")
)
  .filter((project) => !project.data.draft)
  .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf())
  .slice(0, SITE.NUM_PROJECTS_ON_HOMEPAGE);
---

<Layout title={HOME.TITLE} description={HOME.DESCRIPTION}>
  <Container>
    <aside data-pagefind-ignore>
      <h1 class="font-semibold text-black dark:text-white">
        AI News Weekday Roundup
      </h1>
      <div class="space-y-16">
        <section>
          <article class="space-y-4">
            <div>
              <p>We summarize top AI discords + AI reddits + AI X/Twitters, and send you a roundup each day! See <Link href="https://buttondown.email/ainews/archive/" external>archive</Link> for examples. </p>
              <blockquote>
                <p>"Highest-leverage 45 mins I spend everyday" - <Link href="https://twitter.com/soumithchintala/status/1764853209498034537" external>Soumith</Link> </p>
              </blockquote>
              <blockquote>
                <p>"<Link href="https://twitter.com/karpathy/status/1767616494752731633" external>best AI newsletter atm</Link>" and "<Link href="https://x.com/karpathy/status/1857126049357914266" external>I'm not sure that enough people subscribe</Link>" - Andrej </p>
              </blockquote>
              <blockquote>
                <p>"genuinely incredible" - <Link href="https://x.com/chrisalbon/status/1768433442210091170?s=20" external>Chris</Link> </p>
              </blockquote>
              <blockquote>
                <p>"surprisingly decent" - <Link href="https://x.com/HamelHusain/status/1798527078389993674" external>Hamel</Link> </p>
              </blockquote>
              <p>A smol service by @swyx and other <Link href="https://www.latent.space/" external>Latent.Space</Link> friends! </p>
              <p><em>You can pay for a <Link href="https://www.loom.com/share/34b37822c6784989bafd6fcc5fee6420?sid=75bf3b4c-61b5-46fd-a2b1-7c7fe911df89" external>customizable version here</Link>. Thanks to <Link href="https://x.com/swyx/status/1826349521041064012" external>Pieter Levels for the Lex Fridman feature!</Link></em></p>
            </div>
          </article>
        </section>

        <section class="animate space-y-6">
          <div class="flex flex-wrap items-center justify-between gap-y-2">
            <h2 class="font-semibold text-black dark:text-white">
              Last 30 days in AI
            </h2>
            <Link href="/issues"> See all issues </Link>
          </div>
          <div class="relative">
            <div class="absolute left-4 top-0 bottom-0 w-px bg-black/10 dark:bg-white/10 md:block hidden"></div>
            <ul class="not-prose flex flex-col gap-4 relative" id="timeline">
              {
                allIssues.slice(0, ITEMS_PER_PAGE).map((post) => (
                  <li class="relative md:pl-10">
                    <div class="absolute left-[0.9rem] top-3 w-2 h-2 rounded-full bg-black/50 dark:bg-white/50 md:block hidden"></div>
                    <ArrowCard entry={post} />
                  </li>
                ))
              }
            </ul>
            {totalPages > 1 && (
              <div class="mt-8 flex justify-center">
                <button
                  id="load-more"
                  class="rounded-lg border-2 border-black/20 px-4 py-2 font-medium transition-colors hover:bg-black/5 dark:border-white/30 dark:hover:bg-white/5"
                  data-current-page="1"
                  data-total-pages={totalPages}
                >
                  Load 30 more
                </button>
                <a
                  href="/issues"
                  class="ml-4 rounded-lg border-2 border-black/20 px-4 py-2 font-medium transition-colors hover:bg-black/5 dark:border-white/30 dark:hover:bg-white/5"
                >
                  See all
                </a>
              </div>
            )}
          </div>
        </section>

        <section class="animate space-y-4">
          <h2 class="font-semibold text-black dark:text-white">
            Let's Connect
          </h2>
          <article>
            <p>
              If you want to get in touch with me about something or just to say
              hi, reach out on social media or send me an email.
            </p>
          </article>
          <ul class="not-prose flex flex-wrap gap-2">
            {
              SOCIALS.map((SOCIAL) => (
                <li class="flex gap-x-2 text-nowrap">
                  <Link
                    href={SOCIAL.HREF}
                    external
                    aria-label={`${SITE.TITLE} on ${SOCIAL.NAME}`}
                  >
                    {SOCIAL.NAME}
                  </Link>
                  {"/"}
                </li>
              ))
            }
            <li class="line-clamp-1">
              <Link
                href={`mailto:${SITE.EMAIL}`}
                aria-label={`Email ${SITE.TITLE}`}
              >
                {SITE.EMAIL}
              </Link>
            </li>
          </ul>
        </section>
      </div>
    </aside>
  </Container>
</Layout>

<script>
  let isLoading = false;

  function initLoadMore() {
    const loadMoreButton = document.getElementById('load-more');
    const timeline = document.getElementById('timeline');

    if (!loadMoreButton || !timeline) return;

    loadMoreButton.addEventListener('click', async () => {
      if (isLoading) return;
      isLoading = true;
      loadMoreButton.textContent = 'Loading...';

      const currentPage = parseInt(loadMoreButton.dataset.currentPage || '1');
      const totalPages = parseInt(loadMoreButton.dataset.totalPages || '1');
      
      try {
        const response = await fetch(`/api/issues?page=${currentPage + 1}`);
        const data = await response.json();
        
        // Add new items to the timeline
        data.issues.forEach((issue: any) => {
          const li = document.createElement('li');
          li.className = 'relative pl-10';
          li.innerHTML = `
            <div class="absolute left-[0.9rem] top-3 w-2 h-2 rounded-full bg-black/50 dark:bg-white/50"></div>
            <a href="/issues/${issue.id}" class="group relative block rounded-lg border border-black/15 px-4 py-3 transition-colors duration-300 ease-in-out hover:bg-black/5 hover:text-black focus-visible:bg-black/5 focus-visible:text-black dark:border-white/20 dark:hover:bg-white/5 dark:hover:text-white dark:focus-visible:bg-white/5 dark:focus-visible:text-white">
              <div class="flex items-center gap-4">
                <div class="min-w-24 text-sm text-gray-500 dark:text-gray-400">
                  ${new Date(issue.date).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}
                </div>
                <div class="font-semibold">
                  ${issue.title}
                </div>
              </div>
              ${issue.tags ? `
                <div class="mt-1 flex flex-wrap gap-1 pl-24">
                  ${issue.tags.map((tag: string) => `
                    <span class="rounded-sm border border-black/15 px-1.5 py-0.5 text-xs dark:border-white/20">
                      ${tag}
                    </span>
                  `).join('')}
                </div>
              ` : ''}
            </a>
          `;
          timeline.appendChild(li);
        });

        // Update button state
        loadMoreButton.dataset.currentPage = (currentPage + 1).toString();
        if (currentPage + 1 >= totalPages) {
          loadMoreButton.style.display = 'none';
        }
      } catch (error) {
        console.error('Error loading more issues:', error);
        loadMoreButton.textContent = 'Error loading more issues. Try again.';
      } finally {
        isLoading = false;
        if (currentPage + 1 < totalPages) {
          loadMoreButton.textContent = 'Load more issues';
        }
      }
    });
  }

  // Initialize on page load
  initLoadMore();

  // Re-initialize when navigating with View Transitions
  document.addEventListener('astro:page-load', initLoadMore);
</script>
